<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SIM Checker — Normalized (Offline)</title>
<style>
  body{font-family:Arial, Helvetica, sans-serif;background:#f3f6fa;margin:0;padding:18px}
  .wrap{max-width:720px;margin:0 auto}
  .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(15,30,50,0.06);margin-bottom:12px}
  h2{color:#0b76ef;margin:0 0 8px 0}
  input,select,button,textarea{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
  input[type=file]{padding:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .col{flex:1;min-width:160px}
  .result{background:#fafafa;padding:10px;border-radius:8px;margin-top:10px;display:none}
  .error{color:#b00020;margin-top:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
  th{background:#fff2}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>SIM Owner Details Checker — Normalized</h2>
      <div class="small">Type number in any common format (e.g. +92 300 1234567, 3001234567, 03001234567). The tool normalizes it.</div>

      <div style="margin-top:12px" class="row">
        <input id="simIn" class="col" placeholder="Enter SIM (e.g. +92 300 1234567)">
        <button id="checkBtn">Check</button>
        <button id="showAll">Show All Demo Records</button>
      </div>

      <div id="error" class="error"></div>

      <div id="result" class="result">
        <h3>Owner Information</h3>
        <p><strong>SIM:</strong> <span id="rSim"></span></p>
        <p><strong>Owner:</strong> <span id="rOwner"></span></p>
        <p><strong>CNIC:</strong> <span id="rCnic"></span></p>
        <p><strong>Network:</strong> <span id="rNetwork"></span></p>
        <p><strong>Status:</strong> <span id="rStatus"></span></p>
        <p><strong>Registered:</strong> <span id="rDate"></span></p>
      </div>
    </div>

    <div class="card">
      <h3>Add / Edit Demo Record (Local only)</h3>
      <div class="row">
        <input id="addSim" class="col" placeholder="SIM (any format)">
        <input id="addOwner" class="col" placeholder="Owner name">
        <input id="addCnic" class="col" placeholder="CNIC">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="addNetwork" placeholder="Network (Jazz/Telenor/...)" class="col">
        <select id="addStatus" style="width:140px">
          <option>Active</option><option>Inactive</option><option>Blocked</option>
        </select>
        <input id="addDate" placeholder="Reg date (e.g. 2024-01-12)" style="width:160px">
        <button id="addBtn">Add / Update</button>
      </div>
      <div class="small" style="margin-top:8px">Added records are stored in browser localStorage and searchable locally only.</div>
    </div>

    <div class="card">
      <h3>Load CSV (optional)</h3>
      <div class="row">
        <input id="csvFile" type="file" accept=".csv">
        <button id="loadSample">Load Sample CSV</button>
        <button id="clearAll">Clear All Records</button>
      </div>
      <div class="small" style="margin-top:8px">CSV should have columns like: <code>sim,owner,cnic,network,status,regDate</code>. Extra columns OK.</div>
    </div>

    <div class="card">
      <h3>All Records (searchable)</h3>
      <div class="small">Records in memory: <span id="count">0</span></div>
      <table id="tbl">
        <thead><tr><th>#</th><th>SIM</th><th>Owner</th><th>CNIC</th><th>Network</th><th>Status</th><th>RegDate</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* -- Utilities -- */
function normalizeSim(s){
  if(!s) return '';
  s = String(s).trim();
  // remove non-digit characters
  let digits = s.replace(/\\D/g,'');
  if(digits.startsWith('00')) {
    // 00923001234567 -> 03001234567
    if(digits.startsWith('0092')) digits = '0' + digits.slice(4);
  }
  if(digits.startsWith('92') && digits.length >= 11) {
    // 923001234567 -> 03001234567
    digits = '0' + digits.slice(2);
  }
  // if it's 10 digits starting with 3 -> add leading 0
  if(digits.length === 10 && digits.startsWith('3')) digits = '0' + digits;
  // final ensure 11-digit mobile starting with 03
  if(digits.length === 11 && digits.startsWith('03')) return digits;
  // if still not valid, return digits as-is (will be rejected later)
  return digits;
}

function isValidPakSim(s){
  return /^03[0-9]{9}$/.test(s);
}

function saveToLocalStorage(){
  try{ localStorage.setItem('simCheckerRecords', JSON.stringify(records)); }catch(e){}
}
function loadFromLocalStorage(){
  try{
    const raw = localStorage.getItem('simCheckerRecords');
    if(raw) records = JSON.parse(raw);
  }catch(e){ records = []; }
}

/* -- Data & index -- */
let records = [
  {sim:'03001234567', owner:'Ali Khan', cnic:'35202-1234567-1', network:'Jazz', status:'Active', regDate:'2024-01-12'},
  {sim:'03121234567', owner:'Sara Ahmed', cnic:'61101-9876543-2', network:'Telenor', status:'Inactive', regDate:'2023-03-23'},
  {sim:'03211234567', owner:'Usman Malik', cnic:'37405-7654321-3', network:'Zong', status:'Active', regDate:'2024-05-05'}
];
loadFromLocalStorage(); // load user-saved ones
// ensure normalized keys
records = records.map(r => ({...r, sim: normalizeSim(r.sim)}));

const index = {}; // map sim->record for quick lookup
function rebuildIndex(){
  indexKeys = {};
  Object.keys(index).forEach(k=>delete index[k]);
  records.forEach(r=>{ if(r.sim) index[r.sim]=r; });
}
rebuildIndex();
renderTable();

/* -- DOM refs -- */
const simIn = document.getElementById('simIn');
const checkBtn = document.getElementById('checkBtn');
const resultBox = document.getElementById('result');
const err = document.getElementById('error');
const rSim = document.getElementById('rSim'), rOwner = document.getElementById('rOwner'), rCnic = document.getElementById('rCnic'), rNetwork = document.getElementById('rNetwork'), rStatus = document.getElementById('rStatus'), rDate = document.getElementById('rDate');
const addSim = document.getElementById('addSim'), addOwner = document.getElementById('addOwner'), addCnic = document.getElementById('addCnic'), addNetwork = document.getElementById('addNetwork'), addStatus = document.getElementById('addStatus'), addDate = document.getElementById('addDate'), addBtn = document.getElementById('addBtn');
const csvFile = document.getElementById('csvFile'), loadSample = document.getElementById('loadSample'), clearAll = document.getElementById('clearAll');
const tblBody = document.querySelector('#tbl tbody'), countSpan = document.getElementById('count'), showAllBtn = document.getElementById('showAll');

/* -- Actions -- */
checkBtn.addEventListener('click', ()=> {
  err.textContent = ''; resultBox.style.display = 'none';
  let input = simIn.value;
  if(!input){ err.textContent='Please enter a SIM number.'; return; }
  const norm = normalizeSim(input);
  if(!isValidPakSim(norm)){ err.textContent='Number normalized to: ' + norm + ' — but it is not valid Pakistan mobile format (should be 03XXXXXXXXX).'; return; }
  // lookup
  const rec = index[norm] || records.find(r => r.sim === norm);
  if(rec){
    rSim.textContent = rec.sim || norm;
    rOwner.textContent = rec.owner || '—';
    rCnic.textContent = rec.cnic || '—';
    rNetwork.textContent = rec.network || '—';
    rStatus.textContent = rec.status || '—';
    rDate.textContent = rec.regDate || '—';
    resultBox.style.display = 'block';
  } else {
    err.textContent = 'No record found for ' + norm + '. You can add it below if you want (local only).';
  }
});

addBtn.addEventListener('click', ()=>{
  const raw = addSim.value.trim();
  if(!raw){ alert('Provide SIM'); return; }
  const norm = normalizeSim(raw);
  if(!isValidPakSim(norm)){ alert('SIM normalized to "'+norm+'" which is not in 03XXXXXXXXX format. Fix input.'); return; }
  // update or add
  const existing = records.find(r => r.sim === norm);
  const newRec = {sim: norm, owner: addOwner.value.trim(), cnic: addCnic.value.trim(), network: addNetwork.value.trim(), status: addStatus.value, regDate: addDate.value.trim()};
  if(existing){
    Object.assign(existing, newRec);
  } else {
    records.push(newRec);
  }
  rebuildIndex(); saveToLocalStorage(); renderTable();
  alert('Record saved locally for ' + norm);
  // clear inputs
  addSim.value=''; addOwner.value=''; addCnic.value=''; addNetwork.value=''; addDate.value='';
});

showAllBtn.addEventListener('click', ()=> {
  // quick show all demo entries in table (table always shows)
  window.scrollTo({top:0,behavior:'smooth'});
});

loadSample.addEventListener('click', ()=>{
  const sample = 'sim,owner,cnic,network,status,regDate\\n+92 300 1234567,Test User,00000-0000000-0,Jazz,Active,2024-01-01\\n03005556666,Another,11111-1111111-1,Telenor,Inactive,2023-02-02';
  parseCsvText(sample);
});

csvFile.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> { parseCsvText(reader.result); csvFile.value=''; };
  reader.readAsText(f);
});

clearAll.addEventListener('click', ()=>{
  if(!confirm('Clear all locally stored records? This will remove data saved in your browser.')) return;
  records = []; rebuildIndex(); saveToLocalStorage(); renderTable();
});

/* -- CSV parse (simple) -- */
function parseCsvText(text){
  const lines = text.split(/\\r?\\n/).filter(Boolean);
  if(lines.length < 1) return;
  const header = splitCsvLine(lines[0]).map(h=>h.trim().toLowerCase());
  for(let i=1;i<lines.length;i++){
    const vals = splitCsvLine(lines[i]);
    const obj = {};
    header.forEach((h,idx)=> obj[h] = (vals[idx]||'').trim());
    // normalize mapping
    const simRaw = obj.sim || obj.number || obj.msisdn || '';
    const norm = normalizeSim(simRaw);
    const rec = {sim: norm, owner: obj.owner||obj.name||'', cnic: obj.cnic||obj.nid||'', network: obj.network||obj.operator||'', status: obj.status||'', regDate: obj.regdate||obj.reg_date||''};
    if(isValidPakSim(norm)){
      const existing = records.find(r=>r.sim===norm);
      if(existing) Object.assign(existing, rec); else records.push(rec);
    } else {
      // skip invalid sim formats (user sees nothing)
      console.log('Skipped invalid SIM:', simRaw, '->', norm);
    }
  }
  rebuildIndex(); saveToLocalStorage(); renderTable();
  alert('CSV loaded. Total records: ' + records.length);
}

function splitCsvLine(line){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; } else { inQ = !inQ; }
      continue;
    }
    if(ch === ',' && !inQ){ out.push(cur); cur=''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* -- Render table -- */
function renderTable(){
  tblBody.innerHTML = '';
  records.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${escapeHtml(r.sim||'')}</td><td>${escapeHtml(r.owner||'')}</td><td>${escapeHtml(r.cnic||'')}</td><td>${escapeHtml(r.network||'')}</td><td>${escapeHtml(r.status||'')}</td><td>${escapeHtml(r.regDate||'')}</td>`;
    tblBody.appendChild(tr);
  });
  countSpan.textContent = records.length;
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

</script>
</body>
</html>
